<?phpclass Geturl extends CI_Controller{	function index(){		$this->load->model("comm_model","comm");		$data['catid'] = $this->uri->rsegment(3,0);			$main_cate = $this->comm->findAll("category",array("parentid"=>0),"letter asc");		$data['main_cate'] = $main_cate;		$this->load->view('process/geturl',$data);	}		function makeurl(){		$this->load->model("comm_model","comm");		$catid = $this->input->post("catid");		$pnum = $this->input->post("num");		$category = $this->comm->find("category",array("catid"=>$catid));		if(!$category){			echo json_encode(array('code'=>0,"msg"=>'分类不存在'));			die();		}		$url = $this->input->post("url");		if(preg_match("/SearchText/i",$url)){			$searchpos = strrpos($url,"SearchText");			$searchtext = substr($url,$searchpos+strlen("SearchText="));			$searchtext = preg_replace("/[\+]+/","_",$searchtext);			$url = "http://www.alibaba.com/products/F0/".$searchtext."/1.html";		}		if(stripos($url,"http://www.alibaba.com/products/F0/")===false){			echo json_encode(array('code'=>0,"msg"=>'阿里巴巴URL填写不正确'));			die();		}				$numurl = substr($url,strrpos($url,"/"));		$num = $this->preg_substr("\/","\.html",$numurl);		if(!preg_match("/^[0-9]+$/",$num)){			echo json_encode(array('code'=>0,"msg"=>'网址中没有含有页码'));			die();		}				$pos = stripos($url,"http://www.alibaba.com/products/F0/");		$suburl = substr($url,$pos+strlen("http://www.alibaba.com/products/F0/"));		$pos1 = stripos($suburl,"/");		$keyword = substr($suburl,0,$pos1);		$keyword = str_replace("_"," ",$keyword);		$allurl = '';		$aliurl = substr($url,0,strrpos($url,"/"));		$aliurl = base64_encode($aliurl);		if($pnum>0){			for($i=1;$i<=$pnum;$i++){				$allurl.= "http://www.51yunlian.com/index.php/process/get_aliurl_attrs/index/".$catid."/".$aliurl."/{$i}"."\r\n";			}		}		$fp = fopen(FCPATH."wood/{$keyword}.txt","wb");		fwrite($fp,$allurl);		fclose($fp);		//$content = array("catname"=>$category['catname'],"keyword"=>$keyword,"url"=>$url,"content"=>"");		$content = "你选择的类别是:<font color=blue>{$category['catname']}</font>,提交的阿里巴巴URL：{$url}, 搜索的关键词：<span id='keyword'>{$keyword}</span> , <br/><br/>采集地址:<font color=red><span id='mytext'>{$allurl}</span></font>  <a href='/cats/{$keyword}.txt'><span>下载文件(右键链接另存为)</span>";		echo json_encode(array('code'=>1,"msg"=>'数据返回',"content"=>$content));	}			function download(){		$allurl = $this->input->post("text");		$keyword = $this->input->post("keyword");		header("Content-Type: application/octet-stream");		header('Content-Disposition: attachment; filename="'.$keyword.'.txt"');		echo $allurl;	}		function subcategory(){		$this->load->model("comm_model","comm");		$catid = $this->uri->rsegment(3,0);		$catid = intval($catid);				$n = intval($this->uri->rsegment(4,0));		$tcat = $this->comm->find("category",array("catid"=>$catid));		$parents = array();		$tmp = '';		if($tcat['parentid'] == 0){			$parents = $this->comm->findAll("category",array("parentid"=>0),"letter asc");			$tmp.='<select onchange="load_category('.$n.',this.value)" multiple="multiple" size="20" ';			if($n == 1){$tmp .= 'ondblclick="op(this.value);"';}			$tmp .= '>';			foreach($parents as $v){				if($catid==$v['catid']){					$tmp.='<option value="'.$v['catid'].'" selected>'.$v['catname'].'</option>';				}else{					$tmp.='<option value="'.$v['catid'].'">'.$v['catname'].'</option>';				}			}			$tmp.='</select>';		}else{			//$arrparentid = explode(",",$tcat['arrparentid']);			$arrparentid = $this->getpcatids($catid);			if($key = array_search($catid,$arrparentid,true)){				unset($arrparentid[$key]);			}			foreach($arrparentid as $pid){				$parents[$pid] = $this->comm->findAll("category",array("parentid"=>$pid),"letter asc");			}			foreach($parents as $k => $v){				$tmp.='<select onchange="load_category('.$n.',this.value)" multiple="multiple" size="20" ';				if($n == 1){$tmp .= 'ondblclick="op(this.value);"';}				$tmp .= '>';				foreach($v as $c){					foreach($arrparentid as $p){						if($p==$c['catid']){							$tmp.='<option value="'.$c['catid'].'" selected>'.$c['catname'].'</option>';							continue 2;						}					}									if($catid==$c['catid']){						$tmp.='<option value="'.$c['catid'].'" selected>'.$c['catname'].'</option>';					}else{						$tmp.='<option value="'.$c['catid'].'">'.$c['catname'].'</option>';					}				}				$tmp.='</select>';			}		}				$child = array();		$child = $this->comm->findAll("category",array("parentid"=>$catid),"letter asc");				if($tcat['child']==1){			$tmp.='<select onchange="load_category('.$n.',this.value)" multiple="multiple" size="20" ';			if($n == 1){$tmp .= 'ondblclick="op(this.value);"';}			$tmp .= '>';			foreach($child as $s){				$tmp.='<option value="'.$s['catid'].'">'.$s['catname'].'</option>';			}			$tmp.='</select>';		}				header('Content-Type:text/html;charset=utf-8');		echo($tmp);			}			function getsubcatids($catid = null){		if(!$catid){			return false;		}		$thiscat = $this->comm->find("category",array("catid"=>$catid));		if(!$thiscat){			return false;		}				if($thiscat['child']==0){			$thiscat['arrchildid'] = $thiscat['catid'];		}				$subcats = $this->comm->findAll("category","catid in ({$thiscat['arrchildid']}) and child = 0","","catid");		$childids = array();		foreach($subcats as $subcat){			$rs = $this->getpcatids($subcat['catid'],$catid);			if($rs){				foreach($rs as $v){					if(!in_array($v,$childids,true)){						array_push($childids,$v);					}				}			}		}		return $childids;	}		function getpcatids($catid = null, $topcid = 0, $pcats = array()){		if(!$catid){			return false;		}		if($catid == $topcid){			return array($catid);		}		$rs = $this->comm->find("category",array("catid"=>$catid),"","parentid,arrparentid");		if(!$rs){			return false;		}		$arrparentids = explode(",",$rs['arrparentid']);		if(!in_array($topcid,$arrparentids)){			return false;		}		array_unshift($pcats,$catid);		if($rs['parentid'] == $topcid){			array_unshift($pcats,$rs['parentid']);			return $pcats;		}		return $this->getpcatids($rs['parentid'],$topcid,$pcats);	}		function islastcat(){		$catid = intval($this->input->post("catid",true));		if($catid <= 0){			echo json_encode(array("code"=>0,"msg"=>"请先选择类别！"));			die();		}		$rs = $this->comm->find("category",array("catid"=>$catid),"","catid,child");		if(!$rs){			echo json_encode(array("code"=>0,"msg"=>"此类别不存在，请重试！"));			die();		}				if(!$rs['child']){			echo json_encode(array("code"=>1,"msg"=>"last cat"));		}else{			echo json_encode(array("code"=>1,"msg"=>"not last cat"));		}	}			function preg_substr($pattern,$pattern1,$subject){		$re = preg_match("/".$pattern."(.*)".$pattern1."/isU",$subject,$arr);			if($re){			$content = $arr[1];			return $content;		}else{			return false;		}			}}